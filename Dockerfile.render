FROM node:20-alpine

WORKDIR /app

# Instalar dependencias del sistema
RUN apk add --no-cache openssl libc6-compat

# Copiar archivos de dependencias
COPY package*.json ./
COPY prisma ./prisma/

# Instalar dependencias
RUN npm ci

# Generar cliente de Prisma
RUN npx prisma generate

# Copiar cÃ³digo fuente
COPY . .

# Compilar aplicaciÃ³n
RUN npm run build

# Exponer puerto
EXPOSE 4000

# Comando de inicio
CMD ["sh", "-c", "echo 'ğŸ”§ Resolviendo migraciones fallidas...' && node scripts/resolve-failed-migrations.js || echo 'âš ï¸  Continuando...' && echo 'ğŸ“¦ Aplicando migraciones...' && npx prisma migrate deploy && echo 'âœ… Migraciones aplicadas' && echo 'ğŸš€ Iniciando servidor...' && node dist/main.js"]