version: 0.2

phases:
  pre_build:
    commands:
      - echo "Login a Amazon ECR"
      - aws --version
      - aws ecr get-login-password --region $AWS_DEFAULT_REGION | docker login --username AWS --password-stdin $ECR_REPOSITORY_URI
      - |
        export REPOSITORY_URI=$ECR_REPOSITORY_URI
        export COMMIT_HASH=$(echo $CODEBUILD_RESOLVED_SOURCE_VERSION | cut -c 1-7)
        export IMAGE_TAG=${COMMIT_HASH:-latest}
        echo "Repositorio: $REPOSITORY_URI"
        echo "Tag: $IMAGE_TAG"
      - cd $CODEBUILD_SRC_DIR

  build:
    commands:
      - echo "Build iniciado el $(date)"
      - echo "Verificando si la imagen ya existe en ECR..."
      - |
        ECR_REPO_NAME=$(echo $ECR_REPOSITORY_URI | cut -d'/' -f2)
        if aws ecr describe-images --repository-name $ECR_REPO_NAME --image-ids imageTag=$IMAGE_TAG 2>/dev/null; then
          echo "âš ï¸  Imagen con tag $IMAGE_TAG ya existe. Verificando si hay cambios..."
          OLD_DIGEST=$(aws ecr describe-images --repository-name $ECR_REPO_NAME --image-ids imageTag=$IMAGE_TAG --query 'imageDetails[0].imageDigest' --output text)
          echo "Digest actual: $OLD_DIGEST"
          export OLD_DIGEST
        else
          echo "âœ… Imagen nueva, procediendo con build..."
        fi
      - docker build -f Dockerfile.prod -t $REPOSITORY_URI:$IMAGE_TAG .
      - docker tag $REPOSITORY_URI:$IMAGE_TAG $REPOSITORY_URI:latest
      - |
        NEW_DIGEST=$(docker inspect $REPOSITORY_URI:$IMAGE_TAG --format='{{index .RepoDigests 0}}' | cut -d'@' -f2 || echo "new-image")
        echo "Nuevo digest: $NEW_DIGEST"
        if [ -n "$OLD_DIGEST" ] && [ "$NEW_DIGEST" = "$OLD_DIGEST" ]; then
          echo "âš ï¸  La imagen no ha cambiado. Marcando para skip de deployment..."
          echo "SKIP_DEPLOY=true" > /tmp/build.env
        else
          echo "âœ… Imagen nueva o modificada. Deployment necesario."
          echo "SKIP_DEPLOY=false" > /tmp/build.env
        fi

  post_build:
    commands:
      - echo "Push de imagen a ECR"
      - docker push $REPOSITORY_URI:$IMAGE_TAG
      - docker push $REPOSITORY_URI:latest

      - echo "Verificando cluster antes de ejecutar migraciones..."
      - |
        # Verificar si el cluster existe
        CLUSTER_STATUS=$(aws ecs describe-clusters --clusters trabajoya-prod-cluster --query 'clusters[0].status' --output text 2>/dev/null || echo "NOT_FOUND")

        if [ "$CLUSTER_STATUS" != "ACTIVE" ]; then
          echo "âš ï¸  Cluster 'trabajoya-prod-cluster' no encontrado o no estÃ¡ activo (status: $CLUSTER_STATUS)"
          echo "ðŸ’¡ Saltando migraciones. Las migraciones se ejecutarÃ¡n al iniciar el contenedor si estÃ¡ configurado asÃ­."
          echo "SKIP_MIGRATIONS=true" >> /tmp/build.env
        else
          echo "âœ… Cluster encontrado y activo"
          echo "ðŸ” Verificando task definition para migraciones..."
          
          # Verificar si existe task definition de migraciones
          if aws ecs describe-task-definition --task-definition trabajoya-prod-migrations --query 'taskDefinition.taskDefinitionArn' --output text 2>/dev/null > /dev/null 2>&1; then
            echo "âœ… Task definition de migraciones encontrada"
            echo "SKIP_MIGRATIONS=false" >> /tmp/build.env
            echo "MIGRATION_TASK_DEF=trabajoya-prod-migrations" >> /tmp/build.env
          else
            echo "âš ï¸  Task definition 'trabajoya-prod-migrations' no existe"
            echo "ðŸ’¡ Las migraciones se pueden ejecutar manualmente o se ejecutarÃ¡n al iniciar el contenedor"
            echo "SKIP_MIGRATIONS=true" >> /tmp/build.env
          fi
        fi

      - echo "Ejecutando migraciones si estÃ¡n configuradas..."
      - |
        source /tmp/build.env 2>/dev/null || SKIP_MIGRATIONS="true"

        if [ "$SKIP_MIGRATIONS" = "true" ]; then
          echo "â­ï¸  Saltando ejecuciÃ³n de migraciones"
          exit 0
        fi

        # Obtener configuraciÃ³n de red del servicio
        NETWORK_CONFIG=$(aws ecs describe-services \
          --cluster trabajoya-prod-cluster \
          --services trabajoya-prod-backend \
          --query 'services[0].networkConfiguration.awsvpcConfiguration' \
          --output json 2>/dev/null)

        if [ -z "$NETWORK_CONFIG" ] || [ "$NETWORK_CONFIG" = "null" ]; then
          echo "âš ï¸  No se pudo obtener configuraciÃ³n de red del servicio"
          echo "â­ï¸  Saltando migraciones. EjecÃºtalas manualmente o configura la red"
          exit 0
        fi

        echo "ðŸš€ Ejecutando migraciones..."
        CONTAINER_NAME="backend"
        if [ "$MIGRATION_TASK_DEF" = "trabajoya-prod-migrations" ]; then
          CONTAINER_NAME="migrations"
        fi

        aws ecs run-task \
          --cluster trabajoya-prod-cluster \
          --task-definition $MIGRATION_TASK_DEF \
          --launch-type FARGATE \
          --network-configuration "awsvpcConfiguration=$NETWORK_CONFIG" \
          --overrides "{\"containerOverrides\":[{\"name\":\"$CONTAINER_NAME\",\"command\":[\"npx\",\"prisma\",\"migrate\",\"deploy\"]}]}" || {
          echo "âš ï¸  Error al ejecutar migraciones. Continuando con el deployment..."
        }

      - echo "Verificando si se necesita actualizar el servicio..."
      - |
        source /tmp/build.env 2>/dev/null || SKIP_DEPLOY="false"

        # Verificar imagen actual del servicio
        CURRENT_IMAGE=$(aws ecs describe-services \
          --cluster trabajoya-prod-cluster \
          --services trabajoya-prod-backend \
          --query 'services[0].deployments[?status==`PRIMARY`].taskDefinition' \
          --output text | xargs -I {} aws ecs describe-task-definition \
          --task-definition {} \
          --query 'taskDefinition.containerDefinitions[0].image' \
          --output text 2>/dev/null || echo "")

        TARGET_IMAGE="$REPOSITORY_URI:$IMAGE_TAG"
        echo "Imagen actual en servicio: $CURRENT_IMAGE"
        echo "Imagen objetivo: $TARGET_IMAGE"

        if [ "$SKIP_DEPLOY" = "true" ]; then
          echo "â­ï¸  Saltando deployment - imagen no ha cambiado"
          exit 0
        fi

        if [ "$CURRENT_IMAGE" = "$TARGET_IMAGE" ]; then
          echo "â­ï¸  El servicio ya estÃ¡ usando la imagen $TARGET_IMAGE"
          echo "âœ… No se requiere actualizaciÃ³n - evitando crear nuevas tareas"
          exit 0
        fi

        echo "ðŸ“¦ Actualizando task definition con nuevo tag"
        TASK_DEFINITION=$(aws ecs describe-task-definition --task-definition trabajoya-prod-backend --query 'taskDefinition')
        NEW_TASK_DEF=$(echo $TASK_DEFINITION | jq --arg IMAGE "$TARGET_IMAGE" '.containerDefinitions[0].image = $IMAGE | del(.taskDefinitionArn, .revision, .status, .requiresAttributes, .compatibilities, .registeredAt, .registeredBy)')
        NEW_REVISION=$(aws ecs register-task-definition --cli-input-json "$NEW_TASK_DEF" --query 'taskDefinition.revision' --output text)
        echo "Nueva revisiÃ³n registrada: $NEW_REVISION"

      - echo "ðŸ”„ Actualizando servicio SOLO si hay cambios reales"
      - |
        source /tmp/build.env 2>/dev/null || SKIP_DEPLOY="false"

        if [ "$SKIP_DEPLOY" = "true" ]; then
          exit 0
        fi

        # Verificar una vez mÃ¡s antes de actualizar
        CURRENT_IMAGE=$(aws ecs describe-services \
          --cluster trabajoya-prod-cluster \
          --services trabajoya-prod-backend \
          --query 'services[0].deployments[?status==`PRIMARY`].taskDefinition' \
          --output text | xargs -I {} aws ecs describe-task-definition \
          --task-definition {} \
          --query 'taskDefinition.containerDefinitions[0].image' \
          --output text 2>/dev/null || echo "")

        if [ "$CURRENT_IMAGE" = "$REPOSITORY_URI:$IMAGE_TAG" ]; then
          echo "âœ… El servicio ya estÃ¡ actualizado - no se crearÃ¡n nuevas tareas"
          exit 0
        fi

        echo "ðŸš€ Iniciando deployment optimizado..."
        aws ecs update-service \
          --cluster trabajoya-prod-cluster \
          --service trabajoya-prod-backend \
          --task-definition trabajoya-prod-backend:$NEW_REVISION \
          --deployment-configuration "maximumPercent=150,minimumHealthyPercent=50" \
          --health-check-grace-period-seconds 30

      - echo "â³ Esperando que el deployment se estabilice..."
      - |
        source /tmp/build.env 2>/dev/null || SKIP_DEPLOY="false"

        if [ "$SKIP_DEPLOY" = "true" ]; then
          exit 0
        fi

        aws ecs wait services-stable \
          --cluster trabajoya-prod-cluster \
          --services trabajoya-prod-backend \
          --max-attempts 60 \
          --delay 10

      - echo "âœ… Deploy completado. Servicio actualizado sin crear tareas innecesarias"
