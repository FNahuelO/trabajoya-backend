version: 0.2

phases:
  pre_build:
    commands:
      - echo "Login a Amazon ECR"
      - aws --version
      - aws ecr get-login-password --region $AWS_DEFAULT_REGION | docker login --username AWS --password-stdin $ECR_REPOSITORY_URI
      - export REPOSITORY_URI=$ECR_REPOSITORY_URI
      - export COMMIT_HASH=$(echo $CODEBUILD_RESOLVED_SOURCE_VERSION | cut -c 1-7)
      - export IMAGE_TAG=${COMMIT_HASH:-latest}
      - echo "Repositorio:$REPOSITORY_URI"
      - echo "Tag:$IMAGE_TAG"
      - cd $CODEBUILD_SRC_DIR

  build:
    commands:
      - echo "Login a ECR Public Gallery para imágenes base sin límites..."
      - aws ecr-public get-login-password --region us-east-1 | docker login --username AWS --password-stdin public.ecr.aws 2>/dev/null || echo "⚠️  No se pudo hacer login a ECR Public, continuando..."
      - echo "Build iniciado el $(date)"
      - echo "=== Pre-pull de imagen base desde ECR Public ==="
      - docker pull public.ecr.aws/docker/library/node:20-alpine || echo "⚠️  No se pudo hacer pull, continuando..."
      - echo "=== Iniciando build ==="
      - docker build --no-cache --pull -f Dockerfile.prod -t $REPOSITORY_URI:$IMAGE_TAG .
      - docker tag $REPOSITORY_URI:$IMAGE_TAG $REPOSITORY_URI:latest

  post_build:
    commands:
      - echo "Push de imagen a ECR"
      - docker push $REPOSITORY_URI:$IMAGE_TAG
      - docker push $REPOSITORY_URI:latest
      - echo "Actualizando instancias EC2..."
      - |
        TARGET_IMAGE="$REPOSITORY_URI:$IMAGE_TAG"
        PROJECT_NAME="${PROJECT_NAME:-trabajoya-prod}"
        CONTAINER_NAME="${PROJECT_NAME}-backend"

        echo "Imagen objetivo: $TARGET_IMAGE"
        echo "Buscando instancias EC2..."

        if [ -n "$EC2_INSTANCE_ID" ]; then
          INSTANCE_IDS="$EC2_INSTANCE_ID"
        else
          ASG_NAMES=$(aws autoscaling describe-auto-scaling-groups --query "AutoScalingGroups[?contains(AutoScalingGroupName,'trabajoya')||contains(AutoScalingGroupName,'prod')].AutoScalingGroupName" --output text 2>/dev/null || echo "")
          INSTANCE_IDS=""
          if [ -n "$ASG_NAMES" ]; then
            for ASG_NAME in $ASG_NAMES; do
              ASG_INSTANCES=$(aws autoscaling describe-auto-scaling-groups --auto-scaling-group-names "$ASG_NAME" --query "AutoScalingGroups[0].Instances[?HealthStatus=='Healthy'&&LifecycleState=='InService'].InstanceId" --output text 2>/dev/null || echo "")
              if [ -n "$ASG_INSTANCES" ]; then
                INSTANCE_IDS="$INSTANCE_IDS $ASG_INSTANCES"
              fi
            done
          fi
        fi

        if [ -z "$INSTANCE_IDS" ]; then
          echo "No se encontraron instancias activas"
          exit 0
        fi

        echo "Instancias encontradas: $INSTANCE_IDS"

        cat > /tmp/update.sh << 'EOF'
        #!/bin/bash
        set -e
        echo "=== Actualizando contenedor ==="
        REGION=$(curl -s http://169.254.169.254/latest/meta-data/placement/region)
        ACCOUNT_ID=$(aws sts get-caller-identity --query Account --output text)
        echo "Login a ECR..."
        aws ecr get-login-password --region "$REGION" | docker login --username AWS --password-stdin "$ACCOUNT_ID.dkr.ecr.$REGION.amazonaws.com"
        echo "Descargando imagen..."
        docker pull TARGET_IMAGE_PH || docker pull REPO_PH:latest
        if docker ps --format '{{.Names}}' | grep -q '^CONTAINER_PH$'; then
          echo "Reiniciando contenedor..."
          docker restart CONTAINER_PH || (docker stop CONTAINER_PH && docker rm CONTAINER_PH)
        fi
        echo "Actualizacion completada"
        EOF

        sed -i "s|TARGET_IMAGE_PH|${TARGET_IMAGE}|g" /tmp/update.sh
        sed -i "s|REPO_PH|${REPOSITORY_URI}|g" /tmp/update.sh
        sed -i "s|CONTAINER_PH|${CONTAINER_NAME}|g" /tmp/update.sh

        SCRIPT=$(cat /tmp/update.sh)

        for INSTANCE_ID in $INSTANCE_IDS; do
          echo "Actualizando $INSTANCE_ID..."
          COMMAND_ID=$(aws ssm send-command --instance-ids "$INSTANCE_ID" --document-name "AWS-RunShellScript" --parameters commands="$SCRIPT" --timeout-seconds 600 --query 'Command.CommandId' --output text 2>/dev/null || echo "")
          if [ -n "$COMMAND_ID" ]; then
            echo "Comando enviado: $COMMAND_ID"
            for i in $(seq 1 30); do
              STATUS=$(aws ssm get-command-invocation --command-id "$COMMAND_ID" --instance-id "$INSTANCE_ID" --query 'Status' --output text 2>/dev/null || echo "Pending")
              if [ "$STATUS" = "Success" ]; then
                echo "Instancia actualizada OK"
                break
              elif [ "$STATUS" = "Failed" ]; then
                echo "ERROR en instancia"
                aws ssm get-command-invocation --command-id "$COMMAND_ID" --instance-id "$INSTANCE_ID" --query 'StandardErrorContent' --output text 2>/dev/null
                break
              fi
              [ $i -lt 30 ] && sleep 10
            done
          fi
        done

artifacts:
  files:
    - "**/*"
