services:
  - type: web
    name: trabajoya-backend
    env: node
    plan: starter
    region: oregon
    # Build: Instalar dependencias, generar Prisma Client y compilar
    buildCommand: npm ci && npm run prisma:generate && npm run build
    # Start: El script start.sh ejecuta automáticamente:
    #  1. Resuelve migraciones fallidas
    #  2. Aplica migraciones pendientes (npx prisma migrate deploy)
    #  3. Ejecuta seed si la BD está vacía
    #  4. Inicia el servidor
    startCommand: ./scripts/start.sh
    autoDeploy: true
    envVars:
      - key: NODE_ENV
        value: production

      - key: DATABASE_URL
        fromDatabase:
          name: trabajoya-db
          property: connectionString

      - key: PORT
        value: 4000

      - key: ALLOWED_ORIGINS
        value: https://trabajo-ya.com,https://app.trabajo-ya.com

      - key: SWAGGER_ENABLED
        value: "true"

      - key: MAX_FILE_SIZE
        value: "5242880"

      # JWT
      - key: JWT_ACCESS_SECRET
        value: 0ce0d87823817f5e5b708d31a9f713876c141fbcb49e853eecf58a684b74e63dae5d6e55ae1e6b486a44bb580884bdc02acffb8360ab82946ee0da90d5a010b5
      - key: JWT_REFRESH_SECRET
        value: TU_SECRET_REFRESH
      - key: JWT_ACCESS_EXPIRES_IN
        value: 15m
      - key: JWT_REFRESH_EXPIRES_IN
        value: 7d
      - key: JWT_ACCESS_TTL
        value: "900"
      - key: JWT_REFRESH_TTL
        value: "2592000"

      # MAIL (ajustar según usás SES o SMTP)
      - key: MAIL_PROVIDER
        value: ses
      - key: MAIL_FROM
        value: noreply@trabajo-ya.com
      - key: AWS_REGION
        value: us-east-1
      - key: AWS_ACCESS_KEY_ID
        sync: false
      - key: AWS_SECRET_ACCESS_KEY
        sync: false

      # FRONT URL para los links de mails
      - key: APP_WEB_URL
        value: https://app.trabajo-ya.com

      # WebSocket - URL del backend para conexiones WebSocket
      - key: WEBSOCKET_URL
        value: wss://trabajoya-backend.onrender.com

databases:
  - name: trabajoya-db
    databaseName: trabajoya
    user: trabajoya_user
    plan: starter
